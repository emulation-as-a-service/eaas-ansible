version: "{{ docker_compose_file_version }}"

{% if docker_network_name != '' %}
networks:
  {{ docker_network_name }}:
    name: {{ docker_network_name }}
{% if docker_custom_network != '' %}
    external: true
{% endif %}

{% endif %}
services:
  nginx:
    image: nginx
    container_name: nginx
    volumes:
      - {{ docker_image_archive_volume | default("./image-archive", true) }}:/image-archive:ro
      - ./config/nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./config/nginx/proxy.js:/etc/nginx/proxy.js
{% if docker_network_name != '' %}
    networks:
    - {{ docker_network_name }}
{% endif %}

{% if keycloak_enabled %}
  keycloak:
    image: jboss/keycloak
    container_name: keycloak
    environment:
      DB_VENDOR: h2
      KEYCLOAK_USER: {{ keycloak_admin_user}}
      KEYCLOAK_PASSWORD: {{ keycloak_admin_password }}
      KEYCLOAK_FRONTEND_URL: {{ keycloak_frontend_url }}
      KEYCLOAK_ALWAYS_HTTPS: "true"

{% if keycloak_enable_user_groups %}
    command: -Dkeycloak.profile=preview
{% endif %}
  
    volumes:
      - ./keycloak-data:/opt/jboss/keycloak/standalone/data
      - ./theme:/opt/jboss/keycloak/themes/eaas
{% endif %}

  eaas:
    image: {{ docker_custom_image }}
    container_name: {{ host_eaas_service_name }}
    privileged: true
{% if docker_network_name != '' %}
    networks:
    - {{ docker_network_name }}
{% endif %}
    environment:
    - SSL_PROXY={{ docker_ssl_enabled | default("no") | lower }}
{% if not docker_ssl_enabled %}
    - EAAS_PROXYPORT={{ eaas_public_port }}
{% endif %}
    ports:
    - {{ docker_port_mapping }}
{% if docker_network_ports != '' %}
    - {{ docker_network_ports }}
{% endif %}
    volumes:
    - ./log/server:/home/bwfla/bw-fla-server/standalone/log
    - ./server-data:/eaas/server-data
    - {{ docker_objects_volume | default("./objects", true) }}:/eaas/objects
    - {{ docker_export_volume | default("./export", true) }}:/eaas/export
    - {{ docker_image_archive_volume | default("./image-archive", true) }}:/eaas/image-archive
    - {{ docker_import_volume | default("./import", true) }}:/eaas/import
    - {{ host_tmp_storage }}:/tmp-storage
{% if not docker_disable_tmp_volume %}
    - tmpfs_vol:/tmp
{% endif %}
    - ./eaas-ui:/eaas/demo-ui
    - ./config:/eaas/config
    - {{ host_eaas_config_nghttpx_dir }}/nghttpx.conf:/etc/nghttpx/nghttpx.conf
    - ./certificates:/eaas/certificates
    - ./deployments:/eaas/deployments
    - ./welcome-content:/home/bwfla/bw-fla-server/welcome-content
{% for volume in docker_custom_volumes %}
    - {{ volume }}
{% endfor %}
{% if docker_ssl_enabled %}
    extra_hosts:
    - {{ eaas_hostname }}:127.0.0.1
{% endif %}

{% if not docker_disable_tmp_volume %}
volumes:
  tmpfs_vol:
    driver_opts:
      type: tmpfs
      device: tmpfs
{% endif %}