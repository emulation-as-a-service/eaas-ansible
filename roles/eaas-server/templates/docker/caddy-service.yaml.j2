  caddy:
    container_name: caddy
    image: registry.gitlab.com/emulation-as-a-service/experiments/caddy-eaas
    networks:
      eaasi:
        aliases:
          - {{ eaas_hostname }}
    ports:
      - {{ eaas_public_port }}:{{ eaas_public_port }}
{% if eaas_public_port != '80' %} 
      - 80:80
{% endif %}     
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./caddy:/data
    labels:
      caddy_0.order: error last
      caddy: {{ eaas_base_url }} 
      caddy.redir: / /admin/
      caddy.error: 503
{% if eaas_dns.cf_token is defined %}
      caddy_1: "https://*.{{ eaas_hostname }}"
      caddy_1.tls.dns: lego_deprecated cloudflare
{% endif %} 
    environment:
{% if eaas_dns.cf_token is defined %}
      CLOUDFLARE_DNS_API_TOKEN: {{ eaas_dns.cf_token }}
{% endif %}
